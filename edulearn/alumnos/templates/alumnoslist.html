{% extends 'index.html' %}
{% load static %}
{% load widget_tweaks %}

{% block head %} 
    <link rel="stylesheet" href="{% static 'lib/datatables-pdf/css/buttons.dataTables.min.css' %}"> 
{% endblock head %}

{% block content %}
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1>Lista de Alumnos</h1>
          </div>
        </div>
      </div>
    </section>

    <!-- Main content -->
    <section class="content">
      <div class="row">
        <div class="col-md-12">
          <div class="card card-dark">
            <div class="card-header">
              <h3 class="card-title">Alumnos Registrados</h3>
              <div class="card-tools">
                <button
                  type="button"
                  class="btn btn-tool"
                  data-card-widget="collapse"
                  data-toggle="tooltip"
                  title="Collapse"
                >
                  <i class="fas fa-minus"></i>
                </button>
              </div>
            </div>
            <div class="card-body">
              <table class="table" id="table-alumnos">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Apellido</th>
                    <th>DNI</th>
                    <th>Email</th>
                    <th>Telefono</th>
                    <th>Fecha de Nacimiento</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {% for alumno in alumnos %}
                    <tr>
                      <td>{{ alumno.id }}</td>
                      <td>{{ alumno.nombre }}</td>
                      <td>{{ alumno.apellido }}</td>
                      <td>{{ alumno.dni }}</td>
                      <td>{{ alumno.email }}</td>
                      <td>{{ alumno.telefono }}</td>
                      <td>{{ alumno.fecha_nacimiento }}</td>
                      <td>
                        <a href="{% url 'alumno-edit' alumno.id %}" class="btn btn-warning btn-sm">
                          <i class="fa fa-edit"></i> Editar
                        </a>
                        <button class="btn btn-danger btn-sm btn-delete" data-url="{% url 'alumno-delete' alumno.id %}">
                          <i class="fa fa-trash"></i> Eliminar
                        </button>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="card-footer">
              <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                <i class="fa fa-arrow-left"></i> Volver
              </a>
            </div>
          </div>
        </div>
      </div>
    </section>
{% endblock content %}

{% block javascripts %}
  <script src="{% static 'lib/datatables-pdf/js/dataTables.buttons.min.js' %}"></script>
  <script src="{% static 'lib/datatables-pdf/js/pdfmake.min.js' %}"></script>
  <script src="{% static 'lib/datatables-pdf/js/jszip.min.js' %}"></script>
  <script src="{% static 'lib/datatables-pdf/js/vfs_fonts.js' %}"></script>
  <script src="{% static 'lib/datatables-pdf/js/buttons.html5.min.js' %}"></script>
  <script src="{% static 'lib/datatables-pdf/js/buttons.print.min.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    $(function () {
      $('#table-alumnos').DataTable({
        dom: 'Bfrtip',
        buttons: [
          'csv', 'excel', 'pdf', 'print'
        ]
      });

      // SweetAlert for delete confirmation
      document.querySelectorAll('.btn-delete').forEach(button => {
          button.addEventListener('click', function() {
              const url = this.getAttribute('data-url');
              
              Swal.fire({
                  title: '¿Estás seguro?',
                  text: "No podrás revertir esta acción",
                  icon: 'warning',
                  showCancelButton: true,
                  confirmButtonColor: '#3085d6',
                  cancelButtonColor: '#d33',
                  confirmButtonText: 'Sí, eliminarlo'
              }).then((result) => {
                  if (result.isConfirmed) {
                      fetch(url, {
                          method: 'POST',
                          headers: {
                              'X-CSRFToken': '{{ csrf_token }}'  // Asegúrate de tener el token CSRF
                          }
                      }).then(response => {
                          if (response.ok) {
                              Swal.fire(
                                  'Eliminado!',
                                  'El alumno ha sido eliminado.',
                                  'success'
                              ).then(() => {
                                  window.location.reload();  // Recarga la página
                              });
                          } else {
                              Swal.fire(
                                  'Error',
                                  'Ocurrió un problema al intentar eliminar el alumno.',
                                  'error'
                              );
                          }
                      });
                  }
              });
          });
      });
    });
  </script>
{% endblock javascripts %}
